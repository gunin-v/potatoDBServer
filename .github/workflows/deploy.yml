name: Deploy to prod
run-name: ${{ github.actor }} is pushing to prod üöÄ

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    steps:
      # ‚úÖ –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v3

      # ‚úÖ –®–∞–≥ 2: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          rm: true
          source: "./*"
          target: ${{ secrets.SERVER_PATH }}

      # ‚úÖ –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
      - name: Restart server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
            export PATH=$PATH:$HOME/.nvm/versions/node/$(nvm version)/bin

            cd ${{ secrets.SERVER_PATH }}

            export PORT=${{ secrets.PORT }}
            export DATABASE_URL=${{ secrets.DATABASE_URL }}
            export SWAGGER_SERVER_URL=${{ secrets.SWAGGER_SERVER_URL }}

            pm2 delete potato-bd-server || true
            pm2 start "pnpm run docker" --name potato-bd-server
            pm2 save
