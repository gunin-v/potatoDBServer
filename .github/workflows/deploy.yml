name: Deploy to prod
run-name: ${{ github.actor }} is pushing to prod ðŸš€

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy-prod:
    runs-on: ubuntu-latest

    steps:
      # âœ… Ð¨Ð°Ð³ 1: ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      - name: Checkout code
        uses: actions/checkout@v3

      # âœ… Ð¨Ð°Ð³ 2: ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          rm: true
          source: "./*"
          target: ${{ secrets.SERVER_PATH }}

      # âœ… Ð¨Ð°Ð³ 3: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ Ð¸Ð· ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² GitHub
      - name: Create .env on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cat > ${{ secrets.SERVER_PATH }}/.env <<EOF
            DATABASE_URL="${{ secrets.DATABASE_URL }}"
            PORT=${{ secrets.PORT }}
            SWAGGER_SERVER_URL="${{ secrets.SWAGGER_SERVER_URL }}"
            EOF

      # âœ… Ð¨Ð°Ð³ 4: ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
      - name: Restart server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.SERVER_PATH }}
            docker compose down || true
            docker compose up -d --build
